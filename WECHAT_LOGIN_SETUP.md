# 微信开放平台应用注册和配置指南

## 步骤1：注册微信开放平台账号

### 1.1 访问微信开放平台
- 访问地址：https://open.weixin.qq.com/
- 点击页面右上角的"登录"或"注册"按钮

### 1.2 注册开发者账号
1. 如果没有微信开放平台账号，点击"注册"
2. 使用微信扫码登录
3. 填写注册信息：
   - 邮箱地址（建议使用企业邮箱）
   - 密码（建议使用强密码）
   - 验证邮箱
4. 完成实名认证（需要企业营业执照或个人身份证）

### 1.3 登录开放平台
- 使用注册的账号登录微信开放平台
- 进入开发者中心

---

## 步骤2：创建网站应用并获取AppID和AppSecret

### 2.1 创建网站应用
1. 登录后，进入"管理中心"
2. 点击"网站应用"标签
3. 点击"创建网站应用"按钮

### 2.2 填写应用信息
填写以下信息：
- **应用名称**：IATF CARA Assistant Pro
- **应用简介**：IATF CARA智能助手，提供专业的质量管理体系咨询服务
- **应用官网**：https://iatf-cara-backend.baipj123.workers.dev
- **应用图标**：上传应用图标（建议尺寸：108x108像素）
- **应用简介**：详细描述应用功能

### 2.3 提交审核
1. 填写完信息后，点击"提交审核"
2. 等待微信审核（通常需要1-7个工作日）
3. 审核通过后，您将获得：
   - **AppID**（应用唯一标识符）
   - **AppSecret**（应用密钥，请妥善保管）

### 2.4 保存凭证
**重要提示**：
- AppID格式示例：`wx1234567890abcdef`
- AppSecret格式示例：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
- 请将这两个值保存到安全的地方，AppSecret只显示一次

---

## 步骤3：配置授权回调域名

### 3.1 进入应用详情
1. 在"管理中心"找到刚创建的网站应用
2. 点击应用名称进入应用详情页

### 3.2 配置授权回调域名
1. 找到"网页授权"或"OAuth2.0授权"配置项
2. 点击"修改"或"设置"
3. 添加授权回调域名：
   - **开发环境**：`localhost`（仅用于本地测试）
   - **生产环境**：`iatf-cara-backend.baipj123.workers.dev`
   - 如果有自定义域名，也添加进去

### 3.3 回调URL说明
完整的回调URL格式：
```
https://iatf-cara-backend.baipj123.workers.dev/api/auth/wechat/callback
```

**注意**：
- 只需要填写域名部分，不需要填写完整路径
- 域名必须经过ICP备案
- 不支持IP地址

---

## 步骤4：更新前端和后端配置

### 4.1 更新前端配置
编辑文件：`.env.local`

```bash
# 微信登录配置 - 替换为您的真实微信AppID
VITE_WECHAT_APP_ID=wx1234567890abcdef
```

### 4.2 更新后端配置
编辑文件：`backend/wrangler.toml`

```toml
[vars]
JWT_SECRET = "iatf_cara_jwt_secret_2024_cloudflare"
SUPER_ADMIN_PHONE = "13510420462"
WECHAT_APP_ID = "wx1234567890abcdef"
WECHAT_APP_SECRET = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
```

### 4.3 重新部署Workers
```bash
cd backend
wrangler deploy
```

---

## 步骤5：测试微信登录功能

### 5.1 启动前端开发服务器
```bash
npm run dev
```

### 5.2 测试微信登录
1. 访问前端应用：http://localhost:5173/iatf-cara-pro-1.0/
2. 点击"微信登录"标签
3. 查看生成的二维码
4. 使用微信扫描二维码
5. 在手机上确认登录
6. 验证是否成功登录

### 5.3 常见问题排查

**问题1：二维码生成失败**
- 检查后端是否正常运行
- 检查API_BASE_URL配置是否正确
- 查看浏览器控制台错误信息

**问题2：扫码后无响应**
- 检查微信开放平台回调域名配置
- 检查网络连接
- 查看后端日志

**问题3：登录失败**
- 检查AppID和AppSecret是否正确
- 检查回调域名是否匹配
- 查看后端日志中的错误信息

---

## 注意事项

### 安全建议
1. **AppSecret保密**：
   - 不要将AppSecret提交到代码仓库
   - 不要在前端代码中使用AppSecret
   - 定期更换AppSecret

2. **域名安全**：
   - 确保回调域名使用HTTPS
   - 不要在回调域名中包含敏感信息

3. **用户数据保护**：
   - 遵守微信开放平台的使用规范
   - 不要滥用用户数据
   - 提供隐私政策

### 开发建议
1. **测试环境**：
   - 先在本地环境测试
   - 使用测试账号验证功能
   - 确认无误后再部署到生产环境

2. **错误处理**：
   - 提供友好的错误提示
   - 记录详细的日志
   - 实现重试机制

3. **用户体验**：
   - 优化二维码加载速度
   - 提供清晰的登录指引
   - 支持多种登录方式

---

## 附录：微信开放平台相关链接

- 微信开放平台官网：https://open.weixin.qq.com/
- 微信开放平台文档：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html
- 微信开放社区：https://developers.weixin.qq.com/community/

---

## 总结

完成以上步骤后，您的应用将支持微信登录功能。用户可以使用微信扫码登录，无需记住密码，提升用户体验。

**关键点回顾**：
1. 注册微信开放平台账号并完成实名认证
2. 创建网站应用并获取AppID和AppSecret
3. 配置授权回调域名
4. 更新前端和后端配置
5. 重新部署并测试功能

如有问题，请参考微信开放平台文档或联系微信技术支持。
